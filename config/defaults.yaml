# =============================================================================
# Soup Simulation Configuration
# =============================================================================
# All simulation parameters with their default values. Copy this file and
# modify only the values you want to change - unspecified values use defaults.
#
# Usage: ./soup --config=my-config.yaml
# =============================================================================

# -----------------------------------------------------------------------------
# Display Settings
# -----------------------------------------------------------------------------
screen:
  width: 1280                # Window width in pixels
  height: 720                # Window height in pixels
  target_fps: 60             # Target frame rate (also affects simulation speed in graphics mode)

# -----------------------------------------------------------------------------
# World Size (can be larger than screen; use camera to pan/zoom)
# -----------------------------------------------------------------------------
world:
  width: 2560                # World width in world units (0 = use screen width)
  height: 1440               # World height in world units (0 = use screen height)
                             # Default is 2x screen size for larger flocking areas

# -----------------------------------------------------------------------------
# Physics & Simulation
# -----------------------------------------------------------------------------
physics:
  dt: 0.016666666666666666   # Time step per tick in seconds (1/60 = 60 ticks/sec)
  grid_cell_size: 64.0       # Spatial hash grid cell size; affects neighbor query performance
                             # Should be >= largest vision_range for efficiency

# -----------------------------------------------------------------------------
# Entity Defaults
# -----------------------------------------------------------------------------
entity:
  body_radius: 10.0          # Collision/visual radius of entities in world units
  initial_energy: 0.8        # Starting energy for newly spawned entities (0-1 scale)

# -----------------------------------------------------------------------------
# Entity Capabilities
# All entities have 360° vision divided into fixed sectors.
# Effectiveness varies by angle using configurable vision zones.
# -----------------------------------------------------------------------------
capabilities:
  prey:
    vision_range: 100.0      # Slightly shorter range than predators
    # Vision zones: (angle, width, power) define where vision is most effective
    # Prey have enhanced peripheral vision on both sides for threat detection
    vision_zones:
      - angle: 1.57          # +90° (left side)
        width: 0.87          # ~50° half-width = 100° total zone
        power: 1.0
      - angle: -1.57         # -90° (right side)
        width: 0.87          # ~50° half-width = 100° total zone
        power: 1.0
      - angle: 0.0           # front
        width: 1.0           # ~60° half-width = 120° total zone
        power: 0.3
  predator:
    vision_range: 140.0      # Longer range for hunting
    # Predators have focused forward vision for tracking prey
    vision_zones:
      - angle: 0.0           # front
        width: 1.05          # ~60° half-width = 120° total zone
        power: 1.0
  # Minimum signal effectiveness at worst angles (0-1)
  # Higher = more omnidirectional awareness, lower = stronger specialization
  min_effectiveness: 0.2
  # Shared movement capabilities
  max_speed: 80.0            # Maximum velocity magnitude (world units/sec)
  max_accel: 180.0           # Maximum acceleration for velocity smoothing
  max_turn_rate: 3.5         # Maximum rotation speed (radians/sec)
  drag: 1.2                  # Velocity damping factor; higher = slower stopping
  bite_range: 10.0           # Distance at which predators can bite prey (world units)
  bite_cost: 0.02            # Energy cost per bite attempt (currently unused, see energy.predator.bite_cost)
  thrust_deadzone: 0.1       # Thrust below this value is treated as 0 (encourages dwelling)

# -----------------------------------------------------------------------------
# Population Management
# -----------------------------------------------------------------------------
population:
  initial: 40                # Number of entities spawned at simulation start
  max_prey: 400              # Population cap for prey; prevents runaway growth
  max_pred: 120              # Population cap for predators
  respawn_threshold: 5       # If total population drops below this, trigger respawn
  respawn_count: 5           # How many entities to spawn on respawn trigger
  predator_spawn_chance: 0.25  # Probability a respawned entity is a predator (0-1)
  min_predators: 0             # Minimum predator count; when below, spawn predators
                               # Set to 0 to disable (default)
  min_prey: 0                  # Minimum prey count; when below, spawn prey
                               # Set to 0 to disable (default)

# -----------------------------------------------------------------------------
# Reproduction
# Asexual reproduction occurs when energy exceeds threshold and cooldown expires
# -----------------------------------------------------------------------------
reproduction:
  prey_threshold: 0.85       # Minimum energy for prey to reproduce (0-1)
  pred_threshold: 0.85       # Minimum energy for predators to reproduce (0-1)
                             # Higher threshold = predators must be well-fed to breed
  maturity_age: 8.0          # Minimum age in seconds before entity can reproduce
                             # Prevents immediate reproduction after birth
  prey_cooldown: 8.0         # Seconds between prey reproductions
  pred_cooldown: 12.0        # Seconds between predator reproductions
                             # Longer cooldown = slower predator population growth
  cooldown_jitter: 1.0       # Random +/- variation in initial cooldown (seconds)
                             # Prevents synchronized reproduction waves
  parent_energy_split: 0.55  # Fraction of energy parent keeps after reproduction
  child_energy: 0.35         # Energy child starts with (independent of parent's energy)
  spawn_offset: 15.0         # Base distance child spawns from parent (world units)
  heading_jitter: 0.25       # Random heading variation for child (radians)
  pred_density_k: 0          # Density-dependent predator reproduction: p = prey/(prey+K)
                             # When K > 0, predators breed less when prey are scarce
                             # K=0 disables (default), K=150 is a good starting value

# -----------------------------------------------------------------------------
# Neural Network Mutation
# Controls how offspring brains differ from parents
# -----------------------------------------------------------------------------
mutation:
  rate: 0.05                 # Probability each weight mutates (0-1)
                             # Lower = more stable lineages, slower adaptation
  sigma: 0.08                # Standard deviation of normal mutation perturbation
                             # Higher = larger weight changes when mutations occur
  big_rate: 0.01             # Probability of a "big" mutation (0-1)
                             # Rare large jumps help escape local optima
  big_sigma: 0.40            # Standard deviation for big mutations
  bias_rate_multiplier: 0.5  # Biases mutate at rate * this multiplier
                             # Lower = more stable baseline behaviors

# -----------------------------------------------------------------------------
# Energy Economics
# The balance between these values determines predator-prey dynamics
# -----------------------------------------------------------------------------
energy:
  prey:
    base_cost: 0.015         # Energy drain per second just for existing (metabolism)
    move_cost: 0.120         # Additional cost multiplier for movement (4x increase)
                             # Actual cost = move_cost * (speed/max_speed)^2 * dt
    forage_rate: 0.045       # Energy gain per second at resource=1.0 at grazing speed
    grazing_peak: 0.15       # Speed ratio for optimal foraging (~15% max speed)
    accel_cost: 0.03         # Energy cost multiplier for thrust (acceleration penalty)
  predator:
    base_cost: 0.008         # Low base metabolism allows survival while learning to hunt
    move_cost: 0.025         # Reduced movement cost for chasing
    bite_cost: 0.003         # Energy cost per bite attempt
    bite_reward: 0.50        # Base energy transferred per successful bite
    transfer_efficiency: 0.85 # Fraction of taken energy predator actually receives
    digest_time: 0.8         # Seconds after a kill before predator can bite again
    accel_cost: 0.010        # Energy cost multiplier for thrust (acceleration penalty)

# -----------------------------------------------------------------------------
# Resource Field
# Controls organism grazing behavior
# -----------------------------------------------------------------------------
resource:
  graze_radius: 1            # Grazing kernel radius in cells (1=3x3 kernel, 2=5x5)
  forage_efficiency: 1.0     # Fraction of removed resource that becomes energy (0-1)
  contrast: 2.0              # FBM contrast exponent (higher = sparser oases, more barren areas)
                             # 1.5 = lush, 2.0 = moderate, 3.0 = sparse, 4.0+ = very sparse

# -----------------------------------------------------------------------------
# Refugia Mechanics
# High-resource zones provide protection for prey
# -----------------------------------------------------------------------------
refugia:
  strength: 0.5              # Bite success = 1 - strength * resourceHere
                             # At strength=0.5 and resource=1.0: 50% bite success
                             # At strength=0.5 and resource=0.5: 75% bite success

# -----------------------------------------------------------------------------
# Neural Network Architecture
# WARNING: Changing these requires recompiling - they affect array sizes
# -----------------------------------------------------------------------------
neural:
  num_hidden: 16             # Hidden layer neurons (must match neural/ffnn.go)
  num_outputs: 3             # Output neurons: turn, thrust, bite (must match neural/ffnn.go)

# -----------------------------------------------------------------------------
# Sensor Configuration
# WARNING: num_sectors affects array sizes - requires recompile to change
# -----------------------------------------------------------------------------
sensors:
  num_sectors: 8             # Vision divided into this many angular sectors (360°)
                             # More sectors = finer directional resolution
                             # Total inputs = num_sectors * 3 + 2 (must match systems/sensors.go)
  resource_sample_distance: 0.7  # How far ahead to sample resource field (fraction of vision_range)
                                 # Higher = entities "see" resources further away

# -----------------------------------------------------------------------------
# GPU Rendering
# -----------------------------------------------------------------------------
gpu:
  flow_texture_size: 128     # Resolution of flow field texture (pixels)
                             # Higher = smoother visuals but more GPU memory
  flow_update_interval: 30   # Ticks between flow field regeneration
                             # Lower = smoother animation but higher GPU load
  resource_texture_size: 128 # Resolution of resource field texture (pixels)

# -----------------------------------------------------------------------------
# Telemetry & Logging
# -----------------------------------------------------------------------------
telemetry:
  stats_window: 10.0         # Seconds between stats log entries
  bookmark_history_size: 10  # Number of past windows to consider for bookmark detection
  perf_collector_window: 600 # Ticks of performance data to keep (10 sec at 60 tps)

# -----------------------------------------------------------------------------
# Bookmark Detection Thresholds
# Bookmarks flag interesting evolutionary moments for snapshot saving
# -----------------------------------------------------------------------------
bookmarks:
  # Hunt breakthrough: predators suddenly become much more effective killers
  hunt_breakthrough:
    multiplier: 2.0          # Kill rate must exceed rolling average by this factor
    min_kills: 3             # Minimum kills in window to trigger (avoids noise)

  # Forage breakthrough: prey discover better resource utilization
  forage_breakthrough:
    multiplier: 2.0          # Resource utilization must exceed average by this factor
    min_resource: 0.3        # Minimum absolute resource level to trigger

  # Predator recovery: predators bounce back from near-extinction
  predator_recovery:
    min_population: 3        # Must have dropped to this level or below
    recovery_multiplier: 3   # Must recover to min_population * this
    min_final: 6             # Must reach at least this many predators

  # Prey crash: sudden population collapse (often due to predator efficiency)
  prey_crash:
    drop_percent: 0.30       # Population must drop by this fraction from peak
    min_drop: 10             # Minimum absolute drop in count

  # Stable ecosystem: sustained coexistence without major fluctuations
  stable_ecosystem:
    min_prey: 10             # Need at least this many prey
    min_pred: 3              # Need at least this many predators
    cv_threshold: 0.04       # Coefficient of variation squared threshold
                             # Lower = stricter stability requirement
    stable_windows: 5        # Must maintain stability for this many consecutive windows

# -----------------------------------------------------------------------------
# Hall of Fame (Intelligent Reseeding)
# When a species drops to critical levels, reseed from proven lineages instead
# of random brains. This preserves selection pressure while preventing extinction.
# -----------------------------------------------------------------------------
hall_of_fame:
  enabled: true              # Enable hall of fame reseeding
  size: 30                   # Maximum entries per kind (prey/predator)
  reseed_threshold: 2        # Reseed when population drops below this
  reseed_count: 3            # Number of entities to reseed per check
  reseed_energy: 0.9         # Initial energy for reseeded entities

  # Fitness calculation weights (weighted score per kind)
  # Prey:     children * 3.0 + survival_sec * 0.1 + total_foraged * 1.0
  # Predator: children * 3.0 + survival_sec * 0.1 + kills * 2.0
  fitness:
    children_weight: 3.0     # Direct evolutionary fitness
    survival_weight: 0.1     # Longevity contribution
    kills_weight: 2.0        # Predator hunting success
    forage_weight: 1.0       # Prey resource efficiency

  # Entry criteria (organism must meet at least one set)
  # Primary: reproduced at least once
  # Secondary: survived long enough AND achieved something
  entry:
    min_children: 1          # Primary: reproduced at least once
    min_survival_sec: 60.0   # Secondary: minimum survival time
    min_foraging: 0.5        # Secondary (prey): minimum total foraged
    min_kills: 1             # Secondary (predator): minimum kills

# -----------------------------------------------------------------------------
# Particle-Based Resource System
# Mass-conserving resource transport with particles drifting in a flow field
# -----------------------------------------------------------------------------
particles:
  max_count: 8000            # Maximum particle pool size
  spawn_rate: 100            # Base particles/sec (scaled by potential field)
  initial_mass: 0.01         # Mass of newly spawned particle
  deposit_rate: 2.0          # Fraction of particle mass deposited to grid per sec
  pickup_rate: 0.5           # Mass pickup rate from grid per sec
  flow_strength: 40.0        # Flow velocity scale (world units/sec)
  flow_grid_size: 32         # Flow field resolution (independent of resource grid)
                             # Lower = larger features, less computation
  flow_update_sec: 30.0      # Flow field transition interval (seconds)
  flow_scale: 2.0            # Curl noise frequency (lower = larger features)
  flow_octaves: 2            # FBM detail level (fewer = smoother currents)
  flow_evolution: 0.03       # Temporal drift rate for flow field (lower = slower change)
  pot_update_sec: 2.0        # Potential field rebuild interval (seconds)
