# =============================================================================
# Soup Simulation Configuration
# =============================================================================
# All simulation parameters with their default values. Copy this file and
# modify only the values you want to change - unspecified values use defaults.
#
# Usage: ./soup --config=my-config.yaml
# =============================================================================

# -----------------------------------------------------------------------------
# Display Settings
# -----------------------------------------------------------------------------
screen:
  width: 1280                # Window width in pixels
  height: 720                # Window height in pixels
  target_fps: 60             # Target frame rate (also affects simulation speed in graphics mode)

# -----------------------------------------------------------------------------
# World Size (can be larger than screen; use camera to pan/zoom)
# -----------------------------------------------------------------------------
world:
  width: 2560                # World width in world units (0 = use screen width)
  height: 1440               # World height in world units (0 = use screen height)
                             # Default is 2x screen size for larger flocking areas

# -----------------------------------------------------------------------------
# Physics & Simulation
# -----------------------------------------------------------------------------
physics:
  dt: 0.016666666666666666   # Time step per tick in seconds (1/60 = 60 ticks/sec)
  grid_cell_size: 64.0       # Spatial hash grid cell size; affects neighbor query performance
                             # Should be >= largest vision_range for efficiency

# -----------------------------------------------------------------------------
# Entity Defaults
# -----------------------------------------------------------------------------
entity:
  body_radius: 10.0          # Collision/visual radius of entities in world units
  initial_energy: 1.0        # Starting energy for newly spawned entities (absolute units)
  max_energy: 1.5            # Maximum energy capacity per organism (absolute units)

# -----------------------------------------------------------------------------
# Entity Capabilities (Shared)
# Vision range and weights are now per-archetype (see archetypes section).
# -----------------------------------------------------------------------------
capabilities:
  min_effectiveness: 0.05    # Minimum vision weight floor (0-1)
  max_speed: 80.0            # Maximum velocity magnitude (world units/sec)
  max_accel: 180.0           # Maximum acceleration for velocity smoothing
  max_turn_rate: 3.5         # Maximum rotation speed (radians/sec)
  drag: 1.2                  # Velocity damping factor; higher = slower stopping
  bite_range: 10.0           # Distance at which organisms can bite (world units)
  thrust_deadzone: 0.1       # Thrust below this value is treated as 0 (encourages dwelling)

# -----------------------------------------------------------------------------
# Population Management
# -----------------------------------------------------------------------------
population:
  initial: 40                # Number of entities spawned at simulation start
  max_prey: 400              # Population cap for prey; prevents runaway growth
  max_pred: 120              # Population cap for predators
  respawn_threshold: 0       # If total population drops below this, trigger respawn (0 = disabled)
  respawn_count: 5           # How many entities to spawn on respawn trigger
  predator_spawn_chance: 0.25  # Probability a respawned entity is a predator (0-1)
  min_predators: 0             # Minimum predator count; when below, spawn predators
                               # Set to 0 to disable (default)
  min_prey: 0                  # Minimum prey count; when below, spawn prey
                               # Set to 0 to disable (default)

# -----------------------------------------------------------------------------
# Reproduction
# Asexual reproduction occurs when energy exceeds threshold and cooldown expires
# -----------------------------------------------------------------------------
reproduction:
  prey_threshold: 0.85       # Minimum energy ratio (value/max) for prey to reproduce
  pred_threshold: 0.85       # Minimum energy ratio (value/max) for predators to reproduce
                             # Higher threshold = must be well-fed to breed
  maturity_age: 8.0          # Minimum age in seconds before entity can reproduce
                             # Prevents immediate reproduction after birth
  prey_cooldown: 8.0         # Seconds between prey reproductions
  pred_cooldown: 12.0        # Seconds between predator reproductions
                             # Longer cooldown = slower predator population growth
  cooldown_jitter: 1.0       # Random +/- variation in initial cooldown (seconds)
                             # Prevents synchronized reproduction waves
  parent_energy_split: 0.55  # Fraction of energy parent keeps after reproduction
                             # Child receives the remainder (conservation-based transfer)
  spawn_offset: 15.0         # Base distance child spawns from parent (world units)
  heading_jitter: 0.25       # Random heading variation for child (radians)
  pred_density_k: 0          # Density-dependent predator reproduction: p = prey/(prey+K)
                             # When K > 0, predators breed less when prey are scarce
                             # K=0 disables (default), K=150 is a good starting value
  prey_density_k: 0          # Soft prey carrying capacity: p = K/(N+K)
                             # At N=K, 50% breed probability. K=0 disables (default)
  newborn_hunt_cooldown: 2.0 # Seconds before newborn predators can bite
                             # Prevents cascade kills when offspring spawn in prey swarms

# -----------------------------------------------------------------------------
# Neural Network Mutation
# Controls how offspring brains differ from parents
# -----------------------------------------------------------------------------
mutation:
  rate: 0.05                 # Probability each weight mutates (0-1)
                             # Lower = more stable lineages, slower adaptation
  sigma: 0.08                # Standard deviation of normal mutation perturbation
                             # Higher = larger weight changes when mutations occur
  big_rate: 0.01             # Probability of a "big" mutation (0-1)
                             # Rare large jumps help escape local optima
  big_sigma: 0.40            # Standard deviation for big mutations
  bias_rate_multiplier: 0.5  # Biases mutate at rate * this multiplier
                             # Lower = more stable baseline behaviors

# -----------------------------------------------------------------------------
# Energy Economics (Unified)
# All costs are base values multiplied by the organism's metabolic_rate.
# Diet determines food source access: grazing scales by (1-diet), hunting by diet.
# -----------------------------------------------------------------------------
energy:
  # Base costs (multiplied by metabolic_rate)
  base_cost: 0.007           # Energy drain per second for existing (metabolism)
  move_cost: 0.035           # Movement cost multiplier: move_cost * (speed/max_speed)^2 * dt
  accel_cost: 0.012          # Acceleration cost multiplier: accel_cost * thrust^2 * dt

  # Unified feeding (multiplied by metabolic_rate, scaled by diet)
  feeding_rate: 0.06         # Base intake rate (grazing per sec, bite damage)
  feeding_efficiency: 0.80   # Fraction of intake converted to energy
  cooldown_factor: 1.5       # Digest cooldown = energy_gained * cooldown_factor / metabolic_rate

# -----------------------------------------------------------------------------
# Resource Field
# Controls resource regeneration dynamics
# -----------------------------------------------------------------------------
resource:
  graze_radius: 1            # Grazing kernel radius in cells (1=3x3 kernel, 2=5x5)
  regen_rate: 0.430          # Regeneration rate when below capacity (per second)
  decay_rate: 0.169          # Decay rate when above capacity (per second)

# -----------------------------------------------------------------------------
# Potential Field Generation
# Controls the 3D OpenSimplex noise that determines resource hotspot distribution.
# Hotspots drift smoothly over time via the time dimension of the noise.
# -----------------------------------------------------------------------------
potential:
  scale: 0.70                # Base noise frequency (lower = larger hotspots)
  octaves: 6                 # FBM octaves (fewer = smoother, less noisy)
  lacunarity: 3.0            # Frequency multiplier per octave
  gain: 0.77                 # Amplitude multiplier per octave (higher = brighter peaks)
  contrast: 8.0              # FBM contrast exponent (higher = sharper edges, sparser hotspots)
                             # 1.5 = lush, 2.0 = moderate, 3.0 = sparse, 4.0+ = very sparse
  time_speed: 0.02          # Speed of hotspot drift (0 = static, 0.02 = slow drift)
  update_interval: 0.25      # Seconds between capacity updates (lower = smoother drift, higher = faster)

# -----------------------------------------------------------------------------
# Refugia Mechanics
# High-resource zones provide protection for prey
# -----------------------------------------------------------------------------
refugia:
  strength: 0.5              # Bite success = 1 - strength * resourceHere
                             # At strength=0.5 and resource=1.0: 50% bite success
                             # At strength=0.5 and resource=0.5: 75% bite success

# -----------------------------------------------------------------------------
# Neural Network Architecture
# WARNING: Changing these requires recompiling - they affect array sizes
# -----------------------------------------------------------------------------
neural:
  num_hidden: 16             # Hidden layer neurons (must match neural/ffnn.go)
  num_outputs: 3             # Output neurons: turn, thrust, bite (must match neural/ffnn.go)

# -----------------------------------------------------------------------------
# Sensor Configuration
# WARNING: num_sectors affects array sizes - requires recompile to change
# -----------------------------------------------------------------------------
sensors:
  num_sectors: 8             # Vision divided into this many angular sectors (360Â°)
                             # More sectors = finer directional resolution
                             # Total inputs = num_sectors * 3 + 3 (must match systems/sensors.go)
  resource_sample_distance: 0.7  # How far ahead to sample resource field (fraction of vision_range)
                                 # Higher = entities "see" resources further away
  diet_threshold: 0.2        # Min diet difference to register as food/threat
                             # e.g., with threshold=0.2, only organisms with diet 0.2+ lower
                             # are seen as food, and 0.2+ higher as threat
  kin_range: 0.2             # Diet range for kin detection (similar diet organisms)
                             # Organisms within this diet difference are seen as kin

# -----------------------------------------------------------------------------
# GPU Rendering
# -----------------------------------------------------------------------------
gpu:
  resource_texture_size: 128 # Resolution of resource field texture (pixels)

# -----------------------------------------------------------------------------
# Telemetry & Logging
# -----------------------------------------------------------------------------
telemetry:
  stats_window: 10.0         # Seconds between stats log entries
  bookmark_history_size: 10  # Number of past windows to consider for bookmark detection
  perf_collector_window: 600 # Ticks of performance data to keep (10 sec at 60 tps)

# -----------------------------------------------------------------------------
# Bookmark Detection Thresholds
# Bookmarks flag interesting evolutionary moments for snapshot saving
# -----------------------------------------------------------------------------
bookmarks:
  # Hunt breakthrough: predators suddenly become much more effective killers
  hunt_breakthrough:
    multiplier: 2.0          # Kill rate must exceed rolling average by this factor
    min_kills: 3             # Minimum kills in window to trigger (avoids noise)

  # Forage breakthrough: prey discover better resource utilization
  forage_breakthrough:
    multiplier: 2.0          # Resource utilization must exceed average by this factor
    min_resource: 0.3        # Minimum absolute resource level to trigger

  # Predator recovery: predators bounce back from near-extinction
  predator_recovery:
    min_population: 3        # Must have dropped to this level or below
    recovery_multiplier: 3   # Must recover to min_population * this
    min_final: 6             # Must reach at least this many predators

  # Prey crash: sudden population collapse (often due to predator efficiency)
  prey_crash:
    drop_percent: 0.30       # Population must drop by this fraction from peak
    min_drop: 10             # Minimum absolute drop in count

  # Stable ecosystem: sustained coexistence without major fluctuations
  stable_ecosystem:
    min_prey: 10             # Need at least this many prey
    min_pred: 3              # Need at least this many predators
    cv_threshold: 0.04       # Coefficient of variation squared threshold
                             # Lower = stricter stability requirement
    stable_windows: 5        # Must maintain stability for this many consecutive windows

# -----------------------------------------------------------------------------
# Hall of Fame (Intelligent Reseeding)
# When a species drops to critical levels, reseed from proven lineages instead
# of random brains. This preserves selection pressure while preventing extinction.
# -----------------------------------------------------------------------------
hall_of_fame:
  enabled: true              # Enable hall of fame reseeding
  size: 30                   # Maximum entries per kind (prey/predator)
  reseed_threshold: 0        # Reseed when population drops below this (0 = disabled)
  reseed_count: 3            # Number of entities to reseed per check
  reseed_energy: 0.9         # Initial energy for reseeded entities

  # Fitness calculation weights (weighted score per kind)
  # Prey:     children * 3.0 + survival_sec * 0.1 + total_foraged * 1.0
  # Predator: children * 3.0 + survival_sec * 0.1 + kills * 2.0
  fitness:
    children_weight: 3.0     # Direct evolutionary fitness
    survival_weight: 0.1     # Longevity contribution
    kills_weight: 2.0        # Predator hunting success
    forage_weight: 1.0       # Prey resource efficiency

  # Entry criteria (organism must meet at least one set)
  # Primary: reproduced at least once
  # Secondary: survived long enough AND achieved something
  entry:
    min_children: 1          # Primary: reproduced at least once
    min_survival_sec: 60.0   # Secondary: minimum survival time
    min_foraging: 0.5        # Secondary (prey): minimum total foraged
    min_kills: 1             # Secondary (predator): minimum kills

# -----------------------------------------------------------------------------
# Detritus (Nutrient Recycling)
# Dead biomass decays slowly back into the resource grid, creating nutrient
# cycling and ecosystem inertia. Detritus is deposited on death and from
# energy overflow; it decays into resource with some loss to heat.
# -----------------------------------------------------------------------------
detritus:
  decay_rate: 0.05             # Fraction of detritus that decays per second
                               # Higher = faster recycling (0.02-0.08 typical)
  decay_efficiency: 0.50       # Fraction of decayed detritus converted to resource
                               # Remainder is lost to heat (0.40-0.70 typical)
  carcass_fraction: 0.70       # Fraction of organism total (Bio+Met) deposited as detritus on death
                               # Remainder is lost to heat (0.60-0.80 typical)

# -----------------------------------------------------------------------------
# Biomass (Two-Pool Energy Model)
# Organisms have two energy pools:
# - Met (metabolic): short-term fuel from eating, used for movement/costs
# - Bio (biomass): structural body mass, grows from surplus Met
# This creates "healthy prey are more rewarding" dynamics and proper nutrient cycling.
# -----------------------------------------------------------------------------
biomass:
  met_per_bio: 1.0             # MaxMet = Bio * this (metabolic capacity per biomass)
  growth_rate: 0.03            # Bio growth per second when surplus Met available
  growth_threshold: 0.8        # Grow only when Met > MaxMet * this (buffer before growing)
  min_bio: 0.3                 # Child starts with this biomass (must grow to BioCap)
  birth_efficiency: 0.8        # Parent pays (childBio + childMet) / this
                               # Inefficiency goes to heat
  bio_cost: 0.003              # Base metabolic drain per Bio per second
                               # Larger bodies cost more to maintain

# -----------------------------------------------------------------------------
# Archetypes (Founder Templates)
# Define organism templates with full capability sets.
# Each archetype specifies diet, metabolic rate, energy capacity, and vision.
# Diet determines food sources: grazing scales by (1-diet), hunting by diet.
# Metabolic rate scales all costs and intake rates.
# -----------------------------------------------------------------------------
archetypes:
  - name: grazer
    diet: 0.0                  # Pure herbivore - grazes only
    metabolic_rate: 1.0        # Standard metabolism
    energy_capacity: 1.5       # Good reserves for transit between patches
    vision_range: 100.0        # Moderate detection range
    # Vision weights: peripheral emphasis for threat detection
    # Sector order: back, back-right, right, front-right, front, front-left, left, back-left
    vision_weights: [0.05, 0.6, 1.0, 0.6, 0.15, 0.6, 1.0, 0.6]

  - name: hunter
    diet: 1.0                  # Pure carnivore - hunts only
    metabolic_rate: 0.75       # Efficient metabolism (ambush predator)
    energy_capacity: 1.2       # Less buffer needed (gets big meals)
    vision_range: 140.0        # Longer range for hunting
    # Vision weights: forward focus for tracking prey
    vision_weights: [0.0, 0.0, 0.0, 0.6, 1.0, 0.6, 0.0, 0.0]

# -----------------------------------------------------------------------------
# Clade Tracking
# Clades are lineage identifiers that track evolutionary divergence.
# Splits occur randomly, or when mutations cause significant behavioral change.
# -----------------------------------------------------------------------------
clades:
  split_chance: 0.005          # Random split probability per birth (0.5%)
  delta_threshold: 0.015       # avgAbsDelta threshold for forced split
  diet_threshold: 0.05         # Diet drift threshold for forced split
